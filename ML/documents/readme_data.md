# Piggy 재무건전성 데이터 설명서

## 1. 프로젝트 개요

### 1.1 연구 목적
개인의 소비 패턴과 저축률을 기반으로 재무건전성을 정량적으로 평가하는 시스템을 개발합니다. **기본 50점 체계**로 0-100점 척도와 4단계 위험도 등급으로 현실적인 평가를 제공합니다.

### 1.2 데이터 융합 방법론
본 프로젝트는 두 가지 이질적 데이터원을 융합하여 포괄적인 금융 건전성 평가 체계를 구축합니다:

1. **KOSIS 통계 데이터**: 한국 가계의 자산, 부채, 상환비율(DSR) 등 거시적 구조적 리스크 기준 제공
2. **Kaggle Fraud Detection 데이터**: 개인별 미시적 소비행태 패턴(규모, 빈도, 구성) 추출

### 1.3 연구 방법론
- KOSIS 데이터를 통한 구조적 건전성 기준 설정
- Kaggle 데이터를 통한 개인별 소비 패턴 모델링
- 두 데이터원의 융합을 통한 현실적 점수 및 라벨 정의
- 머신러닝 모델을 통한 패턴 학습 및 예측

---

## 2. KOSIS 데이터 (`data/가계재무데이터_v0/`)

### 2.1 데이터 구성
```
가계재무데이터_v0/
├── 가구주연령계층별_10세__가계재무건전성_20250901203907.csv
├── 가구주종사상지위별_가계재무건전성_20250901204038.csv
├── 소득5분위별_가계재무건전성_20250901204213.csv
├── 순자산5분위별_가계재무건전성_20250901204246.csv
└── 자산5분위별_가계재무건전성_20250901204234.csv
```

### 2.2 원본 데이터 특징
- **출처**: 통계청 KOSIS (Korean Statistical Information Service)
- **내용**: 한국 가계의 재무건전성 지표
- **차원**: 연령, 소득분위, 자산분위, 종사상지위별 분류
- **인코딩**: EUC-KR (한글 깨짐 방지를 위한 안전 로딩 필요)

### 2.3 표준화된 컬럼 구조
```python
# 자산 관련
- 자산_만원: 총 자산
- 금융자산_만원: 금융자산
- 부채_만원: 총 부채  
- 금융부채_만원: 금융부채

# 소득 및 상환
- 처분가능소득_만원: 가처분소득
- 원리금상환액_만원: 연간 원리금 상환액

# 비율 지표 (%)
- 부채_자산_퍼센트: 부채/자산 비율
- 부채_금융자산_퍼센트: 부채/금융자산 비율
- 금융부채_금융자산_퍼센트: 금융부채/금융자산 비율
```

### 2.4 파생 지표 계산
```python
# DSR (Debt Service Ratio) 근사
상환부담비율 = 원리금상환액_만원 / 처분가능소득_만원

# 퍼센트를 비율로 변환
부채_자산_ratio = 부채_자산_퍼센트 / 100.0
부채_금융자산_ratio = 부채_금융자산_퍼센트 / 100.0
```

### 2.5 구조적 건전성 기준 (보수적 규칙)
다음 3가지 조건을 **모두** 만족하면 건전(1), 아니면 위험(0):
- 부채/자산 ≤ 0.25
- 부채/금융자산 ≤ 1.10  
- 상환부담비율 ≤ 0.25

---

## 3. Kaggle Fraud 데이터 (`data/synth_finance_scored_realistic.csv`)

### 3.1 원본 데이터 정보
- **출처**: Kaggle "Fraud Detection" 데이터셋
- **원래 목적**: 신용카드 사기 탐지
- **활용 목적**: 개인별 소비행태 패턴 추출
- **핵심 식별자**: `cc_num` (카드 번호)

### 3.2 개인별 집계 지표
```python
# 소비 규모
- total_spending: 연간 총 지출액 (만원)
- mean_spending: 거래당 평균 지출액
- n_transactions: 연간 거래 횟수

# 소비 구성 (7대 카테고리 비율, 합=1.0)
- 식료품음료: 식료품 및 음료 지출 비율
- 주거: 주거비 지출 비율  
- 교통: 교통비 지출 비율
- 오락문화: 오락·문화 지출 비율
- 교육육아: 교육·육아 지출 비율
- 보건의료: 보건·의료 지출 비율
- 기타소비: 기타 소비 지출 비율
```

### 3.3 미국-한국 데이터 변환 과정

#### 3.3.1 금액 스케일 조정
```python
# 미국 평균 연지출 → 한국 평균으로 스케일링
KOREA_MEAN_SPENDING = 2500 * 12  # 월 250만원 × 12개월
scale_factor = KOREA_MEAN_SPENDING / 미국_평균_연지출
```

#### 3.3.2 카테고리 매핑
```python
# 미국 카테고리 → 한국 7대 분류
category_mapping = {
    'grocery_pos', 'grocery_net': '식료품음료',
    'gas_transport': '교통', 
    'entertainment': '오락문화',
    'health_fitness': '보건의료',
    # ... 기타 매핑 규칙
}
```

#### 3.3.3 한국 목표 분포 정합화
```python
# 한국 평균 소비구성에 맞춰 분포 조정
target_ratios = {
    '식료품음료': 0.25, '주거': 0.20, '교통': 0.15,
    '오락문화': 0.10, '교육육아': 0.10, 
    '보건의료': 0.08, '기타소비': 0.12
}
```

---

## 4. 점수 계산 시스템 (룰베이스 알고리즘)

### 4.1 저축률 중심 평가 (가장 중요)
**기본 50점**에서 시작하여 저축률에 따라 점수 조정:

```python
def score_row(r):
    # 소비 규모 (작을수록 가점)
    s_scale = 20 if ts<=3000 else (10 if ts<=5000 else 0)
    
    # 필수비중 (50~65%가 최적)
    essential = 식료품음료 + 주거 + 교육육아 + 보건의료
    s_essential = 20 if 0.50<=essential<=0.65 else ...
    
    # 사치비중 (25% 이하가 최적)  
    luxury = 오락문화 + 기타소비
    s_luxury = 20 if luxury<=0.25 else ...
    
    # 균형성 (모든 카테고리 5% 이상)
    s_balance = 10 if all(비율>=0.05) else 0
    
    # 거래수 (200~600건/년이 적정)
    s_trx = 10 if 200<=n_transactions<=600 else 0
    
    # 페널티
    penalty = 0
    if 고정비>0.40: penalty -= 10  # 주거+교통
    if 보건의료<0.05: penalty -= 5
    
    return max(0, min(100, 총점))
```

### 4.2 현실형 점수 (KOSIS 접목)

#### 4.2.1 소득 추정 및 분위 매핑
```python
# 소득 추정 (지출/소득 비율 가정)
s2i = 0.55  # 지출/소득 비율
추정소득 = total_spending / s2i

# 가장 가까운 KOSIS 소득분위에 매핑
→ 해당 분위의 DSR_ref, DebtAsset_ref 적용
```

#### 4.2.2 현실형 점수 계산
```python
# 임계값 설정
DSR_warn, DSR_risk = 0.30, 0.40
DA_warn, DA_risk = 0.50, 0.70

# 기본 점수 50에서 시작 (중간 수준)
s_fin = 50.0

# DSR 기반 감점
if DSR_ref >= DSR_risk: s_fin -= 30
elif DSR_ref >= DSR_warn: s_fin -= 15

# 부채비율 기반 감점  
if DebtAsset_ref >= DA_risk: s_fin -= 20
elif DebtAsset_ref >= DA_warn: s_fin -= 10

# 소득분위 보정
if 소득분위 <= 2: s_fin += 5  # 저소득층 완충
elif 소득분위 >= 4: s_fin -= 5  # 고소득층 엄격
```

### 4.3 점수 체계 (2024년 9월 업데이트)

#### 새로운 점수 기준 (기본 50점)
- **80-100점**: 우수한 재무관리 (안전 등급) 🟢
- **60-79점**: 양호한 수준 (주의 등급) 🟡
- **40-59점**: 개선 필요 (위험 등급) 🟠
- **0-39점**: 심각한 문제 (고위험 등급) 🔴

#### 위험도 등급별 특성
| 등급 | 점수 | 색상 | 설명 |
|------|------|------|------|
| 안전 | 80+ | 녹색 | 재무상태가 매우 건전합니다 |
| 주의 | 60-79 | 노랑 | 약간의 주의가 필요합니다 |
| 위험 | 40-59 | 주황 | 재무관리 개선이 필요합니다 |
| 고위험 | 0-39 | 빨강 | 즉시 재무계획 수정이 필요합니다 |

#### 페르소나 그룹
- **입문 그룹 (0-19점)**: 새싹 투자자, 병아리 세이버
- **성장 그룹 (20-39점)**: 다람쥐 콜렉터, 펭귄 플래너  
- **발전 그룹 (40-59점)**: 여우 매니저, 코알라 밸런서
- **숙련 그룹 (60-79점)**: 부엉이 애널리스트, 늑대 헌터
- **마스터 그룹 (80-100점)**: 독수리 마스터, 용 레전드

### 4.4 지출 패턴 분석 시스템
소비 행태를 세밀하게 분석하여 과소비 및 이상 지출을 탐지:

#### 과소비 탐지 지표
- **월별 지출 증가율**: 전월 대비 20% 이상 증가 시 경고
- **카테고리별 과소비**: 외식/쇼핑/오락 등 선택 지출이 평균 대비 150% 초과
- **충동 구매 패턴**: 단일 거래 금액이 월 평균 지출의 10% 이상
- **정기결제 누적**: 구독 서비스 합계가 월 소득의 5% 초과

#### 갑작스러운 지출 탐지
- **이상 거래 탐지**: 평소 패턴 대비 3배 이상 큰 금액 거래
- **새로운 카테고리**: 최근 3개월간 없던 지출 카테고리 등장
- **시간대 이상**: 새벽/심야 시간대 고액 결제 (2만원 이상)
- **지역 이상**: 평소 활동 반경을 벗어난 지역에서의 지출

#### 지출 패턴 분류
| 패턴 유형 | 특징 | 위험도 | 권장 조치 |
|----------|------|--------|----------|
| 🔴 위험 과소비 | 월 소득 대비 90% 이상 지출 | 높음 | 즉시 지출 제한 필요 |
| 🟡 주의 과소비 | 월 소득 대비 80-90% 지출 | 중간 | 선택 지출 검토 권장 |
| 🟢 정상 소비 | 월 소득 대비 70% 이하 지출 | 낮음 | 현재 패턴 유지 |
| ⚡ 갑작스러운 지출 | 평균 대비 300% 이상 증가 | 높음 | 지출 사유 확인 필요 |

---

## 5. 데이터 처리 파이프라인

### 5.1 KOSIS 데이터 처리
```python
# 1. 안전한 CSV 로딩 (인코딩 자동 감지)
df, encoding = read_csv_safely(csv_path)

# 2. 표준 컬럼명으로 정규화
df = normalize_kosis_table(df, src_path)

# 3. 파생 지표 계산
df = add_derived_indicators(df)

# 4. 구조적 건전성 라벨 생성
df = calculate_kosis_scores(df)
```

### 5.2 Kaggle 데이터 처리
```python
# 1. 개인별 집계
individual_data = fraud_df.groupby('cc_num').agg({
    'amt': ['sum', 'mean', 'count'],
    'category': lambda x: x.value_counts().to_dict()
})

# 2. 카테고리 비율 계산
category_ratios = pivot_table(...)

# 3. 한국 스케일 조정
scaled_amounts = amounts * scale_factor

# 4. 카테고리 매핑 및 정규화
korean_categories = map_to_korean_categories(us_categories)
normalized_ratios = normalize_ratios(korean_categories)
```

### 5.3 점수 및 라벨 생성
```python
# 1. 단순형 점수 (행태 기반)
df['재무건전_점수'] = df.apply(score_row, axis=1)
df['재무건전_라벨'] = (df['재무건전_점수'] >= 60).astype(int)

# 2. 페르소나 시스템
df['페르소나'] = df['재무건전_점수'].apply(get_persona_from_score)

# 3. 지출 패턴 분석
df['과소비_위험도'] = df.apply(detect_overspending_risk, axis=1)
df['갑작스러운_지출'] = df.apply(detect_sudden_expense, axis=1)
df['지출_패턴_분류'] = df.apply(classify_spending_pattern, axis=1)

# 4. 현실형 점수 (KOSIS 접목)
df = add_realistic_scores(df, kosis_reference_table)
```

---

## 6. 핵심 파라미터 및 가정

### 6.1 경로 설정
```python
# KOSIS 데이터 폴더
SEARCH_DIRS = ["./data", "./data/가계재무데이터_v0"]

# Kaggle 데이터 경로  
synth_data_path = "./data/synth_finance_scored_realistic.csv"
```

### 6.2 스케일 및 가정
```python
# 한국 평균 연간 지출 (만원)
KOREA_MEAN_SPENDING = 2500 * 12  # 월 250만원

# 지출/소득 비율 (소득 추정용)
s2i = 0.55

# 현실형 점수 임계값
DSR_warn, DSR_risk = 0.30, 0.40
DebtAsset_warn, DebtAsset_risk = 0.50, 0.70
```

### 6.3 점수 규칙 파라미터
```python
# 필수비중 최적 구간
essential_optimal = (0.50, 0.65)

# 사치비중 임계값  
luxury_threshold = 0.25

# 적정 거래수 구간
transaction_range = (200, 600)

# 페널티 임계값
fixed_cost_threshold = 0.40  # 주거+교통
health_minimum = 0.05        # 보건의료 최소

# 지출 패턴 분석 임계값
overspending_warning = 0.80   # 소득 대비 80% 경고
overspending_danger = 0.90    # 소득 대비 90% 위험
sudden_expense_multiplier = 3.0  # 평균 대비 3배 이상
impulse_purchase_ratio = 0.10    # 월 평균의 10% 이상
subscription_limit = 0.05        # 소득의 5% 이상
```

---

## 7. 데이터의 의미와 한계

### 7.1 의미 있는 점
- **하이브리드 접근**: 구조적 리스크(KOSIS) + 행태적 패턴(Kaggle) 결합  
- **현실성 반영**: 한국 소득분위별 DSR/부채비율 기준 적용  
- **지출 패턴 분석**: 과소비 및 갑작스러운 지출 탐지로 실시간 위험 관리
- **페르소나 기반 맞춤화**: 10단계 동물 캐릭터로 직관적 이해 제공
- **프로토타입 가치**: 연구/해커톤/개념검증 용도로 충분  
- **확장 가능성**: 국내 실데이터로 보정/검증 시 실용성 증대  

### 7.2 주요 한계
- **소득 추정 단순화**: s2i=0.55 단일 상수 (인구집단별 차이 미반영)  
- **카테고리 매핑 단순**: 미국→한국 1:1 매핑 (세분화 부족)  
- **데이터 출처 차이**: Kaggle≠한국 실측 (결제습관, 현금비중 등 차이)  
- **규칙 기반 라벨**: Weak supervision (진짜 '정답' 보장 없음)  
- **분포 가정**: 한국 목표 분포가 가정치 (실측 기반 아님)  

### 7.3 개선 방향
- **데이터 현실화**: 국내 마이크로데이터 (가계동향조사, 카드/PG 샘플)  
- **소득 추정 고도화**: 연령/가구/직업/지역별 소득 회귀 모델  
- **라벨 근거 강화**: 규제/문헌 기반 임계값, 전문가 라벨 결합  
- **카테고리 정교화**: 표준분류표 기반 중·소분류 매핑  
- **검증 체계화**: Out-of-time 분할, 교차검증, 확률 보정  

---

## 8. 실행 순서

1. **환경 준비**: 라이브러리 설치, 경로 확인
2. **KOSIS 처리**: CSV 로드 → 정규화 → 파생지표 → 구조적 기준
3. **Kaggle 처리**: 개인 집계 → 카테고리 비율 → 한국화
4. **단순형 라벨**: 행태 기반 점수/라벨 생성
5. **모델 학습(1차)**: 단순형 라벨로 회귀·분류 학습
6. **현실형 라벨**: KOSIS 참조 적용한 점수/라벨 생성  
7. **모델 학습(2차)**: 현실형 라벨로 재학습
8. **평가 및 시각화**: 성능 지표, 중요도, 분포 분석
9. **모델 저장**: 예측 파이프라인 구축

---

## 9. 파일 구조 요약

```
data/
├── 가계재무데이터_v0/              # KOSIS 원본 CSV 파일들
│   ├── 가구주연령계층별_*.csv      # 연령별 재무건전성
│   ├── 소득5분위별_*.csv          # 소득분위별 재무건전성  
│   ├── 자산5분위별_*.csv          # 자산분위별 재무건전성
│   └── ...
└── synth_finance_scored_realistic.csv  # 처리된 합성 금융 데이터

# 처리 결과 파일들
├── kosis_cleaned.csv              # 정규화된 KOSIS 데이터
├── synth_finance_scored_final.csv # 최종 점수/라벨 포함 데이터
└── synth_finance_realistic_scored.csv # 현실형 점수 포함 데이터
```

이 데이터 구조를 통해 **"소비 패턴 기반 금융 건전성 예측"**이라는 목표를 달성하며, 사회 초년생에게 친숙한 페르소나 시스템으로 결과를 제공합니다.
